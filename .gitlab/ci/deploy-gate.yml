#
# STAGE: DEPLOY-GATE
#

.check-pipeline-status:
  variables:
    # Override these to modify job behavior
    CHECK_BRANCH: $CI_COMMIT_BRANCH
    CHECK_PIPELINE: $PREV_CI_PIPELINE
    CHECK_MARKER: '"status":"success"'

    # Internal variables
    API_CI_PIPELINE_URL: https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/pipelines?ref=$CHECK_BRANCH&per_page=1
    CURR_CI_PIPELINE: $API_CI_PIPELINE_URL&page=1
    PREV_CI_PIPELINE: $API_CI_PIPELINE_URL&page=2
  before_script:
    - echo "$CHECK_PIPELINE"
    - curl -s "$CHECK_PIPELINE" | tee /dev/stderr | grep "$CHECK_MARKER"
  script:
    - exit 0
