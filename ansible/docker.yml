#
# DOCKER HOST
#

- name: docker
  hosts: docker
  become: yes
  roles:
    - role: server
    - role: upgrade
    - role: motd
    - role: packages
    - role: sshkey


- name: microblog
  hosts: docker
  become: yes
  vars:
    microblog_uid: 2918
    # GitHub
    microblog_storage_url:
      clone: https://github.com/sio/microblog
      push:  git@github.com:sio/microblog.git
    # VM paths
    microblog_storage: /docker/microblog/storage
    microblog_storage_key: /docker/microblog/storage.key
    microblog_gitssh_script: /docker/microblog/gitssh
    # Container paths
    container_storage: /storage
    container_storage_key: /storage.key
    container_gitssh_script: /usr/local/bin/gitssh
  tasks:
    - name: create directories
      file:
        state: directory
        path: '{{ item|dirname }}'
      loop:
        - '{{ microblog_storage }}'
        - '{{ microblog_storage_key }}'
        - '{{ microblog_gitssh_script }}'

    - name: copy ssh key for storage
      copy:
        src: '{{ microblog_key }}'
        dest: '{{ microblog_storage_key }}'
        mode: '0600'
        owner: '{{ microblog_uid }}'
        group: '{{ microblog_uid }}'

    - name: create GIT_SSH script for container
      copy:
        dest: '{{ microblog_gitssh_script }}'
        content: |
          #!/bin/sh
          ssh $GIT_SSH_ARGS "$@"
        owner: '{{ microblog_uid }}'
        mode: '0555'

    - name: initialize microblog storage
      git:
        repo: '{{ microblog_storage_url.clone }}'
        dest: '{{ microblog_storage }}'
        accept_newhostkey: yes
        update: no
        remote: origin
      register: clone

    - name: set push url for microblog storage
      when: clone is changed  # noqa no-handler
      command:
        cmd: git remote set-url --push origin "{{ microblog_storage_url.push }}"
        chdir: '{{ microblog_storage }}'

    - name: set directory permissions for microblog storage
      file:
        path: '{{ microblog_storage }}'
        state: directory
        owner: '{{ microblog_uid }}'
        mode: u=rwX,g=,o=
        recurse: yes

    - name: deploy microblog server
      import_role:
        name: docker_compose
      vars:
        docker_compose_project: microblog
        docker_compose_file: '{{ playbook_dir }}/../compose/microblog/compose.yml'
        docker_compose_env:
          # Telegram bot config
          MICROBLOG_STORAGE: '{{ container_storage }}'
          MICROBLOG_USERS: '{{ microblog_users }}'
          MICROBLOG_TOKEN: '{{ microblog_token }}'
          # Privilege deescalation
          USER: '{{ microblog_uid }}:{{ microblog_uid }}'
          # Git configuration for pushing
          GIT_SSH: '{{ container_gitssh_script }}'
          GIT_SSH_ARGS: '-i {{ container_storage_key }}'
      when: molecule_ephemeral_directory is not defined
