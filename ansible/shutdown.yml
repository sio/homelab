---
# Shutdown Linux machines (you probably want to --limit hosts)

- hosts: '{{ limit_hosts|default("all") }}'
  gather_facts: no
  become: yes
  tasks:
    - name: shutdown linux machines
      shell: sleep 2; /sbin/shutdown -c; /sbin/shutdown -h now
      when: 'initial_ping|default({"failed": True}) is failed'
      async: 1  # https://stackoverflow.com/a/48424672
      poll: 0
      changed_when: yes
