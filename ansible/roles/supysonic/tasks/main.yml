---

- name: install required packages
  package:
    name: '{{ item }}'
    state: present
  with_items:
    - python3
    - apache2
    - libapache2-mod-wsgi-py3
    - ffmpeg

- name: create application user group
  group:
    name: '{{ supysonic_user }}'
    state: present

- name: create application user account
  user:
    name: '{{ supysonic_user }}'
    state: present
    shell: /usr/sbin/nologin
    groups: '{{ supysonic_user }}'
    append: yes

- name: calculate application paths
  set_fact:
    supysonic_venv: '/home/{{ supysonic_user }}/supysonic_venv'
    supysonic_cache: '/home/{{ supysonic_user }}/supysonic_cache'
    supysonic_db: '/home/{{ supysonic_user }}/supysonic.db'
    supysonic_admin: 'Admin_{{ lookup("password", "/dev/null length=3 chars=ascii_letters") }}'
    supysonic_pass: '{{ lookup("password", "/dev/null length=9") }}'

- name: create Python virtual environment
  pip:
    name:
      - setuptools
      - pip
    state: latest
    virtualenv: '{{ supysonic_venv }}'
    virtualenv_command: '/usr/bin/python3 -m venv'

- name: install supysonic
  pip:
    name: 'https://github.com/spl0k/supysonic/tarball/master#egg=supysonic[watcher]'
    state: '{{ "latest" if supysonic_update is defined else "present" }}'
    virtualenv: '{{ supysonic_venv }}'

- name: configure supysonic
  template:
    src: templates/supysonic.conf.j2
    dest: '/home/{{ supysonic_user }}/.supysonic'
  notify: reload web server

- name: initialize supysonic database
  command: >
    su - {{ supysonic_user }} --shell=/bin/sh -c
    '{{ supysonic_venv|quote }}/bin/supysonic-cli
    user add {{ supysonic_admin|quote }} -a -p {{ supysonic_pass|quote }}'
  args:
    creates: '{{ supysonic_db }}'
  register: supysonic_init

- name: add music folder to supysonic
  command: >
    su - {{ supysonic_user }} --shell=/bin/sh -c
    '{{ supysonic_venv|quote }}/bin/supysonic-cli
    folder add Library {{ supysonic_music_dir|quote }}'
  when: supysonic_init.changed

- name: show administrator credentials (for new database)
  debug:
    msg: |-
      Created new Supysonic database: {{ supysonic_db }}
      Administrator: {{ supysonic_admin }}
      Password:      {{ supysonic_pass }}
  when: supysonic_init.changed

- name: copy WSGI script
  get_url:
    url: https://github.com/spl0k/supysonic/raw/master/cgi-bin/supysonic.wsgi
    dest: '{{ supysonic_venv }}/supysonic.wsgi'
    mode: '0644'
  notify: reload web server

- name: configure web server
  template:
    src: templates/apache.conf.j2
    dest: '/etc/apache2/sites-enabled/{{ supysonic_url }}.conf'
    mode: '0644'
  notify: reload web server

# TODO: enable SSL with Let's Encrypt or self-signed

- name: start web server
  service:
    name: apache2
    state: started
    enabled: yes

- name: configure watcher
  template:
    src: templates/watcher.service.j2
    dest: '/etc/systemd/system/supysonic-watcher.service'

- name: start watcher
  service:
    name: supysonic-watcher
    state: started
    enabled: yes
    daemon_reload: yes

- name: allow HTTP access
  ufw:
    port: '{{ item }}'
    rule: allow
    proto: tcp
  with_items:
    - http
  notify: reload firewall
