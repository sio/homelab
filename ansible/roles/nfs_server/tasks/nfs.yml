---

- name: configure nfs exports
  template:
    src: templates/exports.j2
    dest: /etc/exports
    mode: '0600'
    backup: yes
  notify: update nfs exports

- name: configure nfs common
  lineinfile:
    path: /etc/default/nfs-common
    mode: '0644'
    regexp: '^{{ item.key }}='
    line: '{{ item.key }}={{ item.value|quote }}'
    backup: yes
  with_dict:
    NEED_STATD: 'no'
    NEED_IDMAPD: 'yes'
  notify: restart nfs server

- name: configure nfs server
  lineinfile:
    path: /etc/default/nfs-kernel-server
    mode: '0644'
    regexp: '^{{ item.key }}='
    line: '{{ item.key }}={{ item.value|quote }}'
    backup: yes
  with_dict:
    RPCNFSDOPTS: '-N 2 -N 3'
    RPCMOUNTDOPTS: '--manage-gids -N 2 -N 3'
  notify: restart nfs server

- name: create /etc/nfs.conf.d
  file:
    path: /etc/nfs.conf.d
    state: directory
    mode: '0755'

- name: override some values in /etc/nfs.conf
  copy:
    content: |
      [nfsd]
      vers2=n
      vers3=n
    dest: /etc/nfs.conf.d/custom.conf
    mode: '0444'
    backup: yes

- name: disable rpcbind
  vars:
    units:
      default:  # bookworm and newer
        - rpcbind.service
        - rpcbind.socket
        - rpc-statd-notify.service
        - rpc-statd.service
      bullseye:
        - rpcbind.service
        - rpcbind.socket
  systemd:
    name: '{{ item }}'
    state: stopped
    masked: yes
    enabled: no
  loop: '{{ units[ansible_distribution_release]|d(units.default) }}'

- name: allow nfs4 in firewall
  ufw:
    port: '2049'
    proto: tcp
    rule: allow
  when: firewall_auto_config|default(True)
