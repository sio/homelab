#
# Install and configure munin master server
#
---
- name: install required packages
  package:
    name:
      - munin
      - munin-node
      - apache2
      - libcgi-fast-perl
      - libapache2-mod-fcgid
    state: present
  notify: restart web server

- name: specify nodes to monitor
  template:
    src: templates/nodes.conf.j2
    dest: /etc/munin/munin-conf.d/nodes.conf

- name: configure web server
  file:
    src: /etc/munin/apache24.conf
    dest: /etc/apache2/sites-enabled/munin.conf
    state: link
  notify: restart web server

- name: allow LAN access to munin reports
  replace:
    dest: /etc/munin/apache24.conf
    regexp: 'Require\s+.*$'
    replace: 'Require ip {{ munin_master_allow_web_cidr }}'
  notify: restart web server

- name: allow LAN access to web interface
  ufw:
    port: '80'
    rule: allow
    proto: tcp
    src: '{{ munin_master_allow_web_cidr }}'
  notify: reload firewall

- name: start web server
  service:
    name: apache2
    state: started
    enabled: yes
