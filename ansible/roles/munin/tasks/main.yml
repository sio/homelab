#
# Install and configure Munin
#
---
- name: install required packages
  package:
    name:
      - munin
      - munin-node
      - apache2
      - libcgi-fast-perl
      - libapache2-mod-fcgid
    state: present
  notify: restart web server

#- name: configure master
#  # Debian default is fine: /etc/munin/munin.conf
#  notify: restart Munin master
#
#- name: configure node
#  # Debian default is fine: /etc/munin/munin-node.conf
#  notify: restart Munin node
#
#- name: enable generic plugins
#  # TODO: /etc/munin/plugin/
#  notify: restart Munin node

- name: configure web server
  file:
    src: /etc/munin/apache24.conf
    dest: /etc/apache2/sites-enabled/munin.conf
    state: link
  notify: restart web server

- name: allow LAN access to Munin reports
  replace:
    dest: /etc/munin/apache24.conf
    regexp: 'Require\s+local'
    replace: 'Require ip 192.168.0.0/16'
  notify: restart web server

- name: allow LAN access to web interface
  ufw:
    port: 80
    rule: allow
    proto: tcp
    src: 192.168.0.0/16
  notify: reload firewall

- name: start services
  service:
    name: '{{ item }}'
    state: started
    enabled: yes
  with_items:
    - munin-node
    - apache2
