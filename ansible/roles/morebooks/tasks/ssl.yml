#
# Enable HTTPS access to the website
#
---
- name: obtain SSL certificate
  command: >  # TODO: disable --staging
    certbot certonly
    --staging
    --apache
    --agree-tos
    --non-interactive
    --cert-name {{ url|quote }}
    --domains {{ url|quote }},www.{{ url|quote }}
  args:
    creates: '/etc/letsencrypt/live/{{ url }}/*.pem'
  when: server == 'apache2'

- name: schedule certificate renewal
  cron:
    name: 'renew letsencrypt certificates'
    job: >
      certbot renew
      --agree-tos
      --non-interactive
      --renew-hook "systemctl restart {{ server }}"
    hour: '2,14'
    minute: '16'

- name: enable SSL support in Apache
  apache2_module:
    name: ssl
    state: present
  when: server == 'apache2'
  notify: reload web server
