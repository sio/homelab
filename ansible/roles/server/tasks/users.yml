#
# Create necessary users and groups
#
---

- name: use fallback value for remote managing user
  set_fact:
    admin_unprivileged: 'unprivileged'
  when: (not admin_unprivileged is defined) and (ansible_user == 'root')

- name: select unprivileged account for remote access
  set_fact:
    admin_unprivileged: '{{ admin_unprivileged|default(ansible_user) }}'

- name: create remote managing user
  user:
    name: '{{ admin_unprivileged }}'
    state: present
    groups: '{{ admin_unprivileged }}'
    append: yes

- name: install ssh keys
  authorized_key:
    user: '{{ admin_unprivileged }}'
    state: present
    key: '{{ lookup("file", item) }}'
  with_items: '{{ ssh_public_keys }}'
  when: item|expanduser is exists
  register: keys
  failed_when: not keys.results|reject('skipped')|list|count|bool
