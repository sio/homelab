#
# Launch daemon and scripts on OS startup
#
---

- name: create unit file for transmission
  template:
    src: templates/daemon.service.j2
    dest: '/etc/systemd/system/{{ transmission_daemon_name }}.service'

- name: create unit files for watch directories
  template:
    src: templates/watchdir.service.j2
    dest: '/etc/systemd/system/{{ transmission_watch_prefix }}-{{ item.name }}.service'
  with_items: '{{ transmission_watch }}'

- name: calculate names for transmission watcher services
  set_fact:
    transmission_watch_services: >-
      ( transmission_watch
      | map(attribute="name")
      | zip_longest([], fillvalue=transmission_watch_prefix)
      | map("reverse")
      | map("join", "-")
      | list
      )

- name: disable distribution default service
  service:
    name: transmission-daemon
    state: stopped
    enabled: no

- name: start transmission and watchers
  service:
    name: '{{ item }}'
    state: started
    enabled: yes
  with_items: '[ "{{ transmission_daemon_name }}" ] + {{ transmission_watch_services }}'
