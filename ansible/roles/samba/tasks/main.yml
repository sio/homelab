---

- name: install packages
  package:
    name:
      - samba
    state: present

- name: create user accounts
  user:
    name: '{{ item.username }}'
    state: present
    create_home: no
  with_items: '{{ samba_users }}'
  loop_control:
    label: '{{ item.username }}'

- name: define passwords for users
  shell: >  # https://stackoverflow.com/a/46428282
    (pdbedit --user={{ item.username }} 2>&1 > /dev/null)
    || echo -e {{ item.password|quote }}'\n'{{ item.password|quote }}
    | smbpasswd -s -a {{ item.username }}
  register: samba_init
  changed_when: 'Added user' in samba_init.stdout
  with_items: '{{ samba_users }}'
  loop_control:
    label: '{{ item.username }}'
  notify: restart samba server

- name: create samba shares
  file:
    path: '{{ item.path }}'
    state: directory
    mode: '{{ item.mode|default("0755") }}'
    owner: '{{ item.owner|default("root") }}'
    group: '{{ item.group|default(item.owner)|default("root") }}'
  with_items: '{{ samba_shares }}'

- name: configure samba server
  template:
    src: templates/samba.conf.j2
    dest: /etc/samba/smb.conf
  notify: restart samba server

- name: start samba server
  service:
    name: smbd
    state: started
    enabled: yes

- name: allow access to shared directories
  ufw:
    rule: allow
    port: '{{ item.key }}'
    proto: '{{ item.value }}'
  with_dict:
    137: udp
    138: udp
    139: tcp
    445: tcp
  notify: reload firewall
