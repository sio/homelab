---

# Media box will run:
# - Interactive shell sessions for unprivileged user
# - Monitoring (munin)
# - File sharing for LAN (samba)
# - Music server (supysonic)
# - DLNA server (minidlna? rygel? gerbera?)
# - Torrents (transmission)

- hosts: mediabox
  become: yes
  vars:
  roles:
    #
    # OS maintenance
    #
    - role: upgrade
    - role: unattended
    - role: motd

    #
    # Interactive shell
    #
    - role: interactive

    #
    # Monitoring
    #
    - role: munin_fdcount
      munin_fdcount_target: transmission-daemon
    - role: munin_master
      munin_master_nodes:
        - name: localhost
          address: 127.0.0.1

    #
    # LAN file sharing
    #
    - role: samba
      samba_shares:
        - name: Torrents
          path: /storage/torrents
          public: yes
          read only: yes

    #
    # Music streaming
    #
    - role: supysonic
      supysonic_music_dir: /storage/music
      supysonic_url: music.potyarkin.ml

    #
    # DLNA server
    #
    - role: gerbera
      gerbera_media_dirs:
        - /storage/torrents/main

    #
    # Torrenting
    #
    - role: deb_url  # Install patched Transmission (without 1024 open files limit)
      deb_url_packages:
        - url: https://github.com/sio/transmission-debian-patched/releases/download/2.94-2.1-buster/transmission-common_2.94-2.1_all.deb
          checksum: sha256:42117eaac71af8fa53b5b0803df986adcd0d3bdaf0a7f0791465f7b2478ad765
        - url: https://github.com/sio/transmission-debian-patched/releases/download/2.94-2.1-buster/transmission-cli_2.94-2.1_amd64.deb
          checksum: sha256:35efc0c6f2576ac7cce5fea5fc1ad88e46e197041af0e9b460c4d2c051c22265
        - url: https://github.com/sio/transmission-debian-patched/releases/download/2.94-2.1-buster/transmission-daemon_2.94-2.1_amd64.deb
          checksum: sha256:ad651ef56c279ca84a827fd112544127fbb6b73e1b8a4c7cd902b94132b34ab7
    - role: transmission
      transmission_instance:
        name: main
        port: 51000
        port_rpc: 9000
        override:
          upload_limit: 3125 # KB/s = 25 Mbit/s
        watch:
          - name: main
            torrents: /storage/torrents/main
            destination: /storage/data/main
            extras: --bandwidth-low --seedratio 2
    - role: transmission
      transmission_instance:
        name: longterm
        port: 51001
        port_rpc: 9001
        override:
          upload_limit: 6250 # KB/s = 50 Mbit/s
        watch:
          - name: longterm
            torrents: /storage/torrents/longterm
            destination: /storage/data/longterm
    - role: transmission
      transmission_instance:
        name: music
        port: 51002
        port_rpc: 9002
        watch:
          - name: music
            torrents: /storage/torrents/music
            destination: /storage/data/music
