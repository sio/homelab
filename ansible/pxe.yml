#
# PXE BOOT SERVER VIRTUAL MACHINE
#

- hosts: pxe
  name: pxe
  become: yes
  tasks:
    - import_role:
        name: server
    - import_role:
        name: upgrade
    - import_role:
        name: motd
    - import_role:
        name: packages
      vars:
        packages_install:
          - curl

    - include_role:
        name: docker_compose
      vars:
        docker_compose_project: pxe-server
        docker_compose_url: https://github.com/sio/netboot-server/raw/master/docker/docker-compose.yml
        docker_compose_env:
          IPXE_SERVER_IP: '{{ ansible_default_ipv4.address }}'
          IPXE_SCRIPT_URL: 'http://pxe/main.ipxe'

    - include_role:
        name: docker_compose
      vars:
        docker_compose_project: ipxe-scripts
        docker_compose_url: https://github.com/sio/netboot-server/raw/master/ipxe/docker-compose.yml

    - name: provide ipxe entrypoint
      get_url:
        url: https://github.com/sio/netboot-server/raw/master/ipxe/main.ipxe
        dest: /stacks/ipxe-scripts/main.ipxe
        mode: '0644'
        backup: yes
      retries: 10
      delay: 2

    - name: download memtest86+
      vars:
        version: 5.31b
        url: https://www.memtest.org/download/{{ version }}/memtest86+-{{ version }}.bin.gz
        dest: /stacks/ipxe-scripts/memtest86+
      shell: |-
        # unarchive refuses to consider gz files as archives
        # <https://github.com/ansible/ansible-modules-core/issues/3241>
        set -euo pipefail
        curl -sSL -o - {{ url|quote }} | gunzip > {{ dest|quote }}
      args:
        creates: '{{ dest }}'
        executable: /bin/bash
        warn: no

    - name: open PXE firewall ports
      ufw:
        port: '{{ item }}'
        rule: allow
        proto: udp
      loop:
        - '67'
        - '68'
        - '69'
        - '4011'
