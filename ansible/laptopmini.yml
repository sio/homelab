#
# Hardware-related configuration for Asus laptop (UL80 aka laptopmini)
#

---
- hosts: laptopmini:!unreachable
  name: laptopmini
  become: yes
  roles:
    - role: server
    - role: upgrade
    - role: smarttest
    - role: packages
      packages_install:
        # Desktop apps
        - smplayer
        - transgui
        - audacious

        # Desktop environment
        - task-xfce-desktop
        - fonts-cantarell
        - numix-gtk-theme
        - xclip
        # xfwm4-themes   # Removed from Buster repos
        - gvfs-backends  # Android file transfer over USB
        - rar
        - unrar

        # Interactive shell
        - git
        - make
        - tmux
        - vim-gtk3  # GUI build has more stuff enabled at compile time

        # System administration
        - psmisc
        - smartmontools
        - sysbench  # buster-backports

        # Hardware support
        - firmware-linux
        - firmware-linux-free
        - firmware-linux-nonfree

        # Laptop optimisation
        - acpi-support
        - cpufrequtils
        - tlp
        - tlp-rdw

    - role: interactive
      interactive_user: user

    - role: munin_node
    - role: munin_smart
      munin_smart_params: 5 187 197 198  # 188 is meaningless for this drive

    - role: grub
      grub_kernel_params:
        # Boot time user facing output
        - quiet
        - splash
        # Low RAM workaround
        - zswap.enabled=1
        - zswap.compressor=lz4
        - zswap.zpool=z3fold
        - zswap.max_pool_percent=40
        # Attempt to fix Ethernet errors after suspend
        # https://www.linux.org.ru/forum/general/15842902
        - irqpoll
    - role: initrd
      modules:
        # Intel kernel modesetting in initramfs
        - intel_agp
        - drm
        - i915 modeset=1
        # Enable zswap
        - lz4
        - lz4_compress
        - z3fold

    # Strict ssh key management
    - role: sshkey

  pre_tasks:
    - name: enable non-free repository
      apt_repository:
        repo: 'deb http://deb.debian.org/debian {{ ansible_distribution_release }} main contrib non-free'
        state: present
        mode: '0644'

    - name: enable backports repo
      apt_repository:
        repo: 'deb http://deb.debian.org/debian {{ ansible_distribution_release }}-backports main'
        state: present
        mode: '0644'
      when: ansible_distribution_release == 'buster'
