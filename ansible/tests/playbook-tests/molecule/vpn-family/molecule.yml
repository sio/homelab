# Main molecule configuration is located in ansible/roles/tests/molecule.yml
# Invoke with `molecule --base-config $LOCATION`
---
provisioner:
  name: ansible
  env:
    ANSIBLE_ROLES_PATH: ../../../../roles
  inventory:
    group_vars:
      all:
        ansible_python_interpreter: /usr/bin/python3
        server_keys_public:
          - '{{ molecule_ephemeral_directory }}/keys/lab.pub'
        sshkey_allow_extra: yes  # do not delete autogenerated vagrant ssh keys
        sshkey_only:
          op:
            - '{{ molecule_ephemeral_directory }}/keys/lab.pub'
          vagrant:
            - '{{ molecule_ephemeral_directory }}/vagrant-insecure.pub'
        secret_wg_pubkey_iface_trusted: Nrl2nVQxSwrKrvz6jQcrsziuVRPWT9N1Q8/yaQkAXUg=
        secret_wg_pubkey_iface_untrusted: vD2blmqeKsV0OU0GCsGk7NmVth/+FLhLD1xdMX5Yu0I=

### Excerpts from ansible/inventory/vpn-family.yml
        firewall_auto_config: no  # do not use UFW firewall
        wireguard_enable_ip_forward: yes
        wireguard_default_port: 51825
        nftables_open_tcp_ports:
          - ssh
        nftables_template_dir: '{{ playbook_dir }}/../nftables/vpn_edge'
        nftables_templates:
          - main.nft
        nftables_interfaces_trusted:
          - wg_trusted
        nftables_interfaces_untrusted:
          - wg_untrusted
        nftables_interfaces_wan:
          - '{{ ansible_default_ipv4.interface }}'

    host_vars:
      vpn-edge-outer:
        wireguard_iface:
          wg_trusted:
            public_key: '{{ secret_wg_pubkey_iface_trusted }}'
            wireguard_address: 10.133.7.1/24
            wireguard_port: '{{ wireguard_default_port }}'
            wireguard_peers:
              - public_key: '{{ hostvars["vpn-edge-inner"].wireguard_iface.wg_trusted.public_key }}'
                allowed_ips: 10.133.7.2/32,192.168.0.0/16
          wg_untrusted:
            public_key: '{{ secret_wg_pubkey_iface_untrusted }}'
            wireguard_address: 10.133.10.1/24
            wireguard_port: '{{ wireguard_default_port + 1 }}'
            wireguard_peers: []
        nftables_open_udp_ports: '{{ wireguard_iface.values()|map(attribute="wireguard_port")|list }}'

      vpn-edge-inner:
        wireguard_iface:
          wg_trusted:
            public_key: '{{ secret_wg_pubkey_iface_trusted }}'
            wireguard_address: 10.133.7.2/32
            wireguard_port: '{{ wireguard_default_port }}'
            wireguard_peers:
              - public_key: '{{ hostvars["vpn-edge-outer"].wireguard_iface.wg_trusted.public_key }}'
                endpoint: '{{ hostvars["vpn-edge-outer"].ansible_host }}'
                allowed_ips: 0.0.0.0/0
### End of excerpts from ansible/inventory/vpn-family.yml


driver:
  name: vagrant
  provider:
    name: libvirt

platforms:
  - name: vpn-edge-inner
    box: potyarkin/debian11
    memory: 1024
    groups:
      - vpn-edge
  - name: vpn-edge-outer
    box: potyarkin/debian11
    memory: 1024
    groups:
      - vpn-edge

dependency:
  name: shell
  command: >
    /bin/sh -c '
    mkdir -p "$MOLECULE_EPHEMERAL_DIRECTORY/keys"
    && test -f "$MOLECULE_EPHEMERAL_DIRECTORY"/keys/lab
    || ssh-keygen -q -t ed25519 -a 10 -f "$MOLECULE_EPHEMERAL_DIRECTORY"/keys/lab -C "" -N ""
    && ls -l "$MOLECULE_EPHEMERAL_DIRECTORY"/keys/lab*
    '

# Testinfra tests fail because the firewall on test instance
# refuses frequent connection attempts
verifier:
  name: ansible
