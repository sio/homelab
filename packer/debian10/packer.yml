min_packer_version: "1.3.2"  # disk_detect_zeroes

variables:
  root_password: please never use the default value
  hostname: guest-debian10

builders:
  - type: qemu
    format: qcow2
    output_directory: .
    vm_name: '{{ user `hostname` }}-image.qcow2'
    disk_size: 8000

    iso_url: https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-10.3.0-amd64-netinst.iso
    iso_checksum_url: https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/SHA256SUMS
    iso_checksum_type: sha256

    accelerator: kvm
    headless: yes
    memory: 1024
    cpus: 1

    http_directory: .
    ssh_username: root
    ssh_password: temporary-root-password

    disk_compression: yes
    skip_compaction: false
    disk_discard: unmap
    disk_detect_zeroes: unmap

    boot_wait: 1s
    boot_command:
      - <down><tab>  # non-graphical
      - auto
      - preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg
      - hostname={{ user `hostname` }}
      - <enter><wait>

provisioners:
  - type: shell
    inline:
      - echo "root:{{ user `root_password`}}"|chpasswd
      - shutdown -P now
